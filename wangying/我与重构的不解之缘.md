# 我与重构的不解之缘

## 背景
电商平台，交易环节必不可少。如正向交易流程中的购物车、下单页、收银台等；逆向交易的退款、仲裁等。从用户角度看，用户通过业务多样性的层层吸引，来到交易环节，当然很希望高体验高保障的完成交易；从我司的角度，我们需要高效高稳定的提供交易支撑。

## 现状问题

交易环节经历一个长时间的演变，回过头看，存在以下问题：

- **点状分布，无法可控**

  每个交易页面逻辑都很个体化，形成了点，但没有考虑上下游的应用情况，无法感知，导致无法串成线，组成面。当业务场景逐渐增多时，只能每个点修修补补，为了兼容功能，会出现交互不流畅和维护成本增高。

- **冗余代码逻辑较多**

  业务发展过程中，有很多阶段性的试错，后续被遗忘，出现断层遗留。在做需求迭代时，很容易被潜在逻辑坑一把。当然，代码冗余，必定会在性能上有折损。

- **注释文档缺失**

  依靠人的记忆和扒代码，确认应用范围，定位问题和维护迭代，均有效率损失

- **资源无法共享**

  随着公共规范的建设成型，交易使用的react技术栈与移动端vue技术栈的规范约束相违背。很多公共能力无法复用，增加了研发成本；独立维护迭代，也无法反哺公共能力。

-------------------
无论从业务的快速支撑，还是技术变现来看，以上问题都会造成人效和系统稳定性上的损失。

考虑到我司业务的未来增势，交易能够更好地支撑住业务。我们需要化被动为主动：**重构迫在眉睫**

## 如何重构

  曾经，我以为确定重构的项目后，接下来准备工作：

  1.简单过线上流程，大致了解结构

  2.粗略的过一遍原有的工程代码

  3.与产品聊一下历史逻辑

  然后，就可以确定技术方案，歘歘歘的写完代码和文档，就完事了。

  但开发过程的坎坷和上线后的返工，让我意识到这样的重构还不够。

  >**做为项目重构的发起者，其角色不仅仅是一个前端开发者。TA是产品，是设计师，是测试，更是一个用户。**

  以重构购物车项目为例，记录下重构的一些**心得**：

- ##### 前期充分收集信息
 1. 通过熟悉工程代码和借助PM/RD/QA等认知，梳理出需覆盖的页面及页面详尽的功能，产出PRD。

![原型图](https://wangxiaohei-1305010039.cos.ap-beijing.myqcloud.com/img/1613645421940.jpg)

2. 根据PRD原型跑通线上所有流程，整理细节交互。有些特殊逻辑、情景，模拟困难，找测试同学一起配合，尽可能还原应用场景。

![购物车](https://wangxiaohei-1305010039.cos.ap-beijing.myqcloud.com/img/%E8%B4%AD%E7%89%A9%E8%BD%A6.jpeg)

- ##### 项目目标同步

  1.以项目负责人心态组织项目启动会或评审会，与PM/UI/RD/QA确认项目的完整性，讨论出不足点和改进点，达成共识。

  2.以用户使用角度，体验优化，UE操作流畅，性能达标

  3.模块柯里化，复用最大化，组装最优化

- ##### 技术方案设计

 > 重构，**不求快，求稳，求极致**

 在做技术方案时，不仅考虑用已知能力去解决问题，可以抱着**目标结果最优化**，尝试引入新技术方式解决问题。虽然会带来一定的时间成本，但值得。

- 输出业务功能框架和流程图：
	1. 项目基础结构图
	![项目基础结构图](https://wangxiaohei-1305010039.cos.ap-beijing.myqcloud.com/img/%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84%E5%9B%BE.jpg)
	2. 流程图
	![项目基础结构图](https://wangxiaohei-1305010039.cos.ap-beijing.myqcloud.com/img/%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg)

  - 功能模块拆分设计


  - 接入公共能力

    1.组件库

    2.离线包

    3.TS类型检测

    4. ...

  - 性能提升点

    1.骨架屏方案

    2.按需加载方案

  - 文档自动生成
  - 数据漏斗

    1. 埋点上报

    2. 接口标识上报


- ##### 技术方案评审

	技术方案设计完成后，组织产品、UI、研发、测试进行需求评审，整体回归项目，对项目需求进行最终确认。


 接下来，可以按照正常的项目流程进行，如排期，开发日报，阶段风险同步，测试回归，复盘等。

 这次购物车重构，虽然还有优化控件，但整个过程很清晰，顺畅许多。

 以上，是不完全的重构心得。


### 总结
重构的目的是为了以后新加功能时更容易，让新功能可以尽快上线，代码的结构清晰，让代码变得可读、可维护、可扩，实际是在为以后做准备。
